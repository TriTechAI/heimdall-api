# 代码审查规范 (Code Review Guidelines)

本文档定义了 `heimdall` 项目的代码审查标准、流程和最佳实践，旨在确保代码质量、知识传播和团队协作效率。

## 1. 核心原则

### 1.1. 审查目标

- **🎯 质量保证**: 确保代码符合项目规范和最佳实践
- **🐛 缺陷预防**: 在代码合并前发现和修复潜在问题
- **📚 知识传播**: 通过审查过程传播技术知识和经验
- **🔧 设计改进**: 识别和改进架构设计问题
- **📖 可读性**: 确保代码易于理解和维护

### 1.2. 审查哲学

- **建设性反馈**: 提供具体、可操作的改进建议
- **学习导向**: 将审查视为学习和成长的机会
- **质量优先**: 质量胜过进度，不妥协基本标准
- **团队协作**: 促进开放、尊重的协作文化
- **持续改进**: 不断优化审查流程和标准

## 2. 审查流程

### 2.1. PR 提交前准备

**代码作者必须完成以下自检：**

- [ ] **功能完整**: 按照任务描述完成所有功能点
- [ ] **编译通过**: `go build ./...` 无错误
- [ ] **测试通过**: `go test ./...` 全部通过
- [ ] **代码格式**: `go fmt` 和 `go vet` 检查通过
- [ ] **依赖管理**: `go mod tidy` 已执行
- [ ] **规范遵循**: 符合所有项目开发规范
- [ ] **文档更新**: 相关文档已同步更新

### 2.2. PR 创建规范

- **标题格式**: 遵循 Conventional Commits 规范
- **描述完整**: 包含变更说明、测试方法、影响评估
- **关联 Issue**: 使用 `Closes #<issue-number>` 关联
- **合适大小**: 单个 PR 不超过 500 行代码变更
- **原子性**: 一个 PR 只做一件事，避免混合不相关的变更

### 2.3. 审查分配

- **自动分配**: 根据代码路径自动分配相关领域的审查者
- **强制审查**: 所有 PR 必须至少有 1 名审查者批准
- **关键审查**: 架构变更、安全相关代码需要 2 名审查者
- **专家审查**: 特定领域的代码需要对应专家审查

### 2.4. 审查时效

- **响应时间**: 审查者应在 24 小时内开始审查
- **完成时间**: 一般 PR 应在 48 小时内完成审查
- **紧急 PR**: 标记为紧急的 PR 应在 4 小时内完成
- **大型 PR**: 超过 300 行的 PR 可延长至 72 小时

## 3. 审查检查清单

### 3.1. 通用质量检查

#### 🏗️ 架构和设计
- [ ] **单一职责**: 每个函数/类都有明确、单一的职责
- [ ] **模块边界**: 代码放在正确的模块和包中
- [ ] **依赖方向**: 依赖关系符合架构设计
- [ ] **接口设计**: API 设计符合 RESTful 规范
- [ ] **错误处理**: 错误处理完整且一致

#### 📖 代码可读性
- [ ] **命名清晰**: 变量、函数、类型名称具有描述性
- [ ] **注释适度**: 复杂逻辑有适当注释，避免过度注释
- [ ] **函数原子化**: 单个函数不超过 40 行（建议），不超过 50 行（强制）
- [ ] **单一职责**: 每个函数只做一件事情，遵循原子化原则
- [ ] **嵌套层级**: 避免过深的嵌套，建议不超过 4 层
- [ ] **代码重复**: 没有明显的代码重复

#### 🔒 安全性
- [ ] **输入验证**: 所有外部输入都有适当验证
- [ ] **权限控制**: 敏感操作有权限检查
- [ ] **SQL 注入**: 数据库查询使用参数化查询
- [ ] **XSS 防护**: 用户输入输出有适当转义
- [ ] **敏感信息**: 没有硬编码密码、密钥等敏感信息

#### ⚡ 性能考虑
- [ ] **算法效率**: 使用合适的算法和数据结构
- [ ] **数据库查询**: 避免 N+1 查询，使用适当索引
- [ ] **内存使用**: 避免内存泄漏，及时释放资源
- [ ] **并发安全**: 并发代码有适当的同步机制

### 3.2. Go 语言特定检查

#### 🚀 Go 最佳实践
- [ ] **错误处理**: 遵循 Go 错误处理惯例
- [ ] **接口使用**: 接口定义在使用方，遵循"小接口"原则
- [ ] **并发模式**: 正确使用 goroutine 和 channel
- [ ] **包结构**: 包的组织符合 Go 项目布局标准
- [ ] **命名约定**: 遵循 Go 命名约定（驼峰式、首字母大小写规则）

#### 🔧 go-zero 框架检查
- [ ] **API 定义**: `.api` 文件是唯一的接口定义来源
- [ ] **代码生成**: 没有手动修改 `goctl` 生成的代码
- [ ] **Logic 层**: 业务逻辑正确放在 `logic` 层
- [ ] **DAO 使用**: 数据访问通过 `common/dao` 层进行
- [ ] **配置管理**: 所有配置通过 `etc/*.yaml` 文件管理

### 3.3. 微服务架构检查

#### 🏢 服务边界
- [ ] **功能归属**: 功能放在正确的服务中
- [ ] **数据隔离**: 服务间数据访问通过 API 而非直接数据库访问
- [ ] **共享代码**: 共享逻辑正确放在 `common` 模块
- [ ] **服务依赖**: 服务间依赖关系清晰且最小化

#### 🔄 API 契约
- [ ] **向后兼容**: API 变更保持向后兼容性
- [ ] **版本管理**: 正确使用 API 版本控制
- [ ] **错误响应**: 统一的错误响应格式
- [ ] **文档同步**: API 文档与实现保持同步

### 3.4. 测试质量检查

#### 🧪 测试完整性
- [ ] **测试覆盖**: Logic 层测试覆盖率 ≥ 85%
- [ ] **测试场景**: 包含正常和异常场景测试
- [ ] **Mock 使用**: 正确使用 `mockey` 进行依赖 Mock
- [ ] **测试独立**: 测试之间相互独立，无依赖
- [ ] **TDD 遵循**: 遵循红-绿-重构的 TDD 流程

#### 📊 测试质量
- [ ] **断言清晰**: 使用 `goconvey` 的清晰断言
- [ ] **测试命名**: 测试名称描述性强
- [ ] **边界测试**: 包含边界条件和错误情况测试
- [ ] **性能测试**: 性能关键代码有相应的基准测试

### 3.5. 数据库和 MongoDB 检查

#### 🗃️ 数据模型
- [ ] **模型设计**: 符合 MongoDB 建模规范
- [ ] **索引设计**: 为常用查询字段创建索引
- [ ] **文档大小**: 避免单个文档过大（< 16MB）
- [ ] **字段命名**: 使用 `camelCase` 命名规范
- [ ] **BSON 标签**: 正确使用 `bson` 标签

#### 🔍 查询优化
- [ ] **查询效率**: 使用高效的查询模式
- [ ] **投影字段**: 只查询需要的字段
- [ ] **分页实现**: 正确实现分页查询
- [ ] **聚合管道**: 复杂查询使用聚合管道

## 4. 审查工作流

### 4.1. 审查者职责

#### 📋 审查准备
1. **理解上下文**: 阅读 PR 描述和关联 Issue
2. **检出代码**: 在本地检出并测试 PR 分支
3. **运行测试**: 确保所有测试通过
4. **理解变更**: 理解代码变更的目的和影响

#### 🔍 审查执行
1. **系统性检查**: 按照检查清单逐项审查
2. **深度分析**: 重点关注复杂逻辑和关键路径
3. **文档验证**: 检查文档是否与代码变更同步
4. **测试评估**: 评估测试的充分性和质量

#### 💬 反馈提供
1. **具体明确**: 提供具体的位置和改进建议
2. **优先级分类**: 区分必须修改、建议改进和讨论点
3. **正面鼓励**: 对好的代码和改进给予正面反馈
4. **学习机会**: 分享相关知识和最佳实践

### 4.2. 作者响应

#### 🔄 反馈处理
1. **及时响应**: 在 24 小时内回应审查反馈
2. **逐项处理**: 对每个反馈点都给出明确回应
3. **质疑讨论**: 对有疑问的反馈主动讨论澄清
4. **感谢学习**: 对有价值的反馈表示感谢

#### ✅ 修改提交
1. **修复问题**: 及时修复必须解决的问题
2. **改进代码**: 采纳合理的改进建议
3. **测试验证**: 确保修改不引入新问题
4. **文档更新**: 同步更新相关文档

### 4.3. 反馈分类

#### 🚨 必须修改 (Must Fix)
- 功能错误或逻辑漏洞
- 安全漏洞或风险
- 性能问题
- 违反项目规范
- 测试缺失或错误

#### 💡 建议改进 (Should Consider)
- 代码可读性改进
- 性能优化建议
- 更好的设计模式
- 代码重构建议
- 最佳实践建议

#### 💭 讨论点 (Discussion)
- 设计选择的权衡
- 技术方案的探讨
- 规范的解释或澄清
- 学习和知识分享
- 未来改进的方向

## 5. 特殊情况处理

### 5.1. 紧急修复

- **快速通道**: 生产问题的紧急修复可走快速审查通道
- **后续补充**: 紧急合并后必须补充完整的测试和文档
- **事后复盘**: 分析问题根因，防止类似问题

### 5.2. 大型重构

- **分阶段审查**: 将大型重构分解为多个小的 PR
- **设计审查**: 重构前进行设计文档审查
- **影响评估**: 充分评估对其他模块的影响
- **回滚方案**: 准备回滚方案和监控指标

### 5.3. 实验性功能

- **特殊标记**: 使用特殊标签标记实验性代码
- **隔离设计**: 确保实验代码不影响主流程
- **监控指标**: 设置监控指标追踪实验效果
- **清理计划**: 制定实验结束后的清理计划

## 6. 审查质量度量

### 6.1. 度量指标

- **审查覆盖率**: 代码审查覆盖的 PR 比例
- **发现缺陷率**: 通过审查发现的缺陷数量
- **审查周期时间**: 从 PR 创建到合并的时间
- **返工率**: 因审查反馈需要返工的比例
- **生产缺陷率**: 合并后在生产环境发现的缺陷

### 6.2. 质量改进

- **定期回顾**: 每月回顾审查质量和效率
- **流程优化**: 基于度量数据优化审查流程
- **工具改进**: 引入工具提高审查效率
- **培训提升**: 定期进行代码审查培训
- **标准更新**: 根据项目发展更新审查标准

## 7. 工具和自动化

### 7.1. 自动化检查

- **代码格式**: 使用 `gofmt` 和 `goimports` 自动格式化
- **静态分析**: 集成 `golangci-lint` 进行静态代码分析
- **安全扫描**: 使用 `gosec` 进行安全漏洞扫描
- **依赖检查**: 检查依赖包的安全性和许可证
- **测试执行**: 自动运行所有测试和覆盖率检查

### 7.2. GitHub 集成

- **PR 模板**: 使用 PR 模板确保信息完整
- **自动标签**: 根据文件变更自动添加标签
- **审查分配**: 自动分配合适的审查者
- **状态检查**: 集成 CI/CD 状态检查
- **合并要求**: 设置合并前的必要条件

## 8. 审查文化建设

### 8.1. 最佳实践

- **正面文化**: 营造建设性、学习导向的审查文化
- **知识分享**: 通过审查传播最佳实践和技术知识
- **相互尊重**: 尊重不同的技术观点和实现方式
- **持续学习**: 将审查视为团队学习和成长的机会
- **质量意识**: 强化代码质量的重要性认知

### 8.2. 冲突解决

- **技术讨论**: 优先通过技术讨论解决分歧
- **规范参考**: 以项目规范作为判断标准
- **专家仲裁**: 复杂问题可请技术专家仲裁
- **团队决策**: 重大分歧通过团队会议决策
- **记录文档**: 重要决策和原因要记录在文档中

---

**代码审查是确保项目代码质量的关键环节，每个团队成员都有责任认真对待并持续改进审查质量。** 